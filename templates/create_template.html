{% extends "base.html" %}

{% block title %}템플릿 생성 - 프롬프트 생성기{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>템플릿 만들기
                </h4>
            </div>
            <div class="card-body">
                <form id="templateForm">
                    <div class="mb-4">
                        <label for="title" class="form-label fw-bold">
                            <i class="fas fa-heading me-1"></i>템플릿 제목 *
                        </label>
                        <input type="text" class="form-control form-control-lg" id="title" required 
                               placeholder="템플릿 제목을 입력하세요">
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-layer-group me-1"></i>템플릿 구조
                            </label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSection(1)">
                                    <i class="fas fa-plus me-1"></i># 제목
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSection(2)">
                                    <i class="fas fa-plus me-1"></i>## 제목
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSection(3)">
                                    <i class="fas fa-plus me-1"></i>### 제목
                                </button>
                            </div>
                        </div>
                        
                        <div id="sectionsContainer">
                            <!-- 섹션들이 동적으로 추가됩니다 -->
                        </div>
                        
                        <div class="text-center mt-3" id="emptySections">
                            <div class="text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                '+' 버튼을 클릭해서 섹션을 추가하세요
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="/templates" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>목록으로
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i>템플릿 저장
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 예시 카드 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>템플릿 예시
                </h6>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code># 역할
너는 시니어 백엔드 개발자야.

# 목적
spring boot 기반 애플리케이션 개발을 위해 테스트 코드를 작성해야해.

# 질문
## 단위 테스트가 뭐야?
- 상세내용1
- 상세내용2

## 통합 테스트가 뭐야?
- 상세내용1
- 상세내용2</code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sectionCounter = 0;
let sections = [];

function addSection(level) {
    sectionCounter++;
    const sectionId = `section_${sectionCounter}`;
    
    const section = {
        id: sectionId,
        level: level,
        title: '',
        content: '',
        order_index: sections.length
    };
    
    sections.push(section);
    renderSections();
    document.getElementById('emptySections').style.display = 'none';
}

function removeSection(sectionId) {
    sections = sections.filter(s => s.id !== sectionId);
    // 순서 재정렬
    sections.forEach((section, index) => {
        section.order_index = index;
    });
    renderSections();
    
    if (sections.length === 0) {
        document.getElementById('emptySections').style.display = 'block';
    }
}

function renderSections() {
    const container = document.getElementById('sectionsContainer');
    container.innerHTML = '';
    
    sections.forEach(section => {
        const div = document.createElement('div');
        div.className = 'card mb-3';
        div.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-bold text-primary">
                        ${'#'.repeat(section.level)} 레벨 ${section.level} 제목
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSection('${section.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" placeholder="섹션 제목을 입력하세요" 
                           value="${section.title}" onchange="updateSection('${section.id}', 'title', this.value)">
                </div>
                <div>
                    <textarea class="form-control" rows="3" placeholder="기본 내용 (선택사항)" 
                              onchange="updateSection('${section.id}', 'content', this.value)">${section.content}</textarea>
                    <small class="text-muted">프롬프트 생성 시 기본값으로 사용됩니다</small>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

function updateSection(sectionId, field, value) {
    const section = sections.find(s => s.id === sectionId);
    if (section) {
        section[field] = value;
    }
}

document.getElementById('templateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const title = document.getElementById('title').value.trim();
    
    if (!title) {
        alert('템플릿 제목을 입력해주세요.');
        return;
    }
    
    if (sections.length === 0) {
        alert('최소 하나의 섹션을 추가해주세요.');
        return;
    }
    
    // 섹션 데이터 검증
    for (let section of sections) {
        if (!section.title.trim()) {
            alert('모든 섹션의 제목을 입력해주세요.');
            return;
        }
    }
    
    const templateData = {
        title: title,
        sections: sections.map(section => ({
            level: section.level,
            title: section.title.trim(),
            content: section.content.trim(),
            order_index: section.order_index,
            parent_id: null // 현재 버전에서는 flat structure
        }))
    };
    
    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(templateData)
        });
        
        if (response.ok) {
            alert('템플릿이 성공적으로 생성되었습니다!');
            window.location.href = '/templates';
        } else {
            const error = await response.json();
            alert('템플릿 생성에 실패했습니다: ' + error.detail);
        }
    } catch (error) {
        alert('오류가 발생했습니다: ' + error.message);
    }
});
</script>
{% endblock %} 